<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Table — Live (from Fixtures)</title>
  <style>
    :root{--accent:#0d6efd;--muted:#6b7280}
    body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;margin:0;background:#f4f6fb;color:#111;padding:18px}
    header{background:var(--accent);color:#fff;padding:14px 18px;font-weight:700;border-radius:8px}
    .wrap{max-width:1100px;margin:18px auto}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:center}
    th{background:#eef4ff}
    .team-cell{display:flex;align-items:center;gap:8px;text-align:left}
    .team-cell img{width:28px;height:28px;border-radius:50%;object-fit:cover}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .stats{font-size:13px;color:var(--muted)}
    @media(max-width:900px){.controls{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <header>League Table — Live (computed from fixtures)</header>

  <div class="wrap">
    <div class="card">
      <div class="controls">
        <div>
          <strong>Standings (FIFA rules):</strong>
          <span class="small">Points → Goal difference → Goals for → Goals against (lower better) → Name</span>
        </div>
        <div class="stats">
          Teams: <span id="teamsCount">0</span> · Fixtures: <span id="fixturesCount">0</span>
          <button id="refreshBtn" style="margin-left:10px;padding:6px 8px;border-radius:6px">Refresh</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:12px" class="card">
        <table id="leagueTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Team</th>
              <th>P</th>
              <th>W</th>
              <th>D</th>
              <th>L</th>
              <th>GF</th>
              <th>GA</th>
              <th>GD</th>
              <th>Pts</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:10px" class="small">
        Note: table is computed from the <code>fixtures</code> collection: a match counts only when both scores are present (live/ongoing matches with scores are included).
      </div>
    </div>
  </div>

  <!-- Use modular Firebase (ES modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // ----- YOUR FIREBASE CONFIG (kept identical to earlier) -----
    const firebaseConfig = {
      apiKey: "AIzaSyAFsHg9fK6IDnHbuxmBleEfIIfVGsuLDik",
      authDomain: "profile-b825d.firebaseapp.com",
      projectId: "profile-b825d",
      storageBucket: "profile-b825d.appspot.com",
      messagingSenderId: "925276859161",
      appId: "1:925276859161:web:194c60f6dbd9f1ef8bf388"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collections
    const teamsCol = collection(db, "teams");
    const fixturesCol = collection(db, "fixtures");

    // DOM refs
    const tbody = document.querySelector("#leagueTable tbody");
    const teamsCountEl = document.getElementById("teamsCount");
    const fixturesCountEl = document.getElementById("fixturesCount");
    const refreshBtn = document.getElementById("refreshBtn");

    // local caches
    let teams = {};    // id -> {name, logoUrl}
    let fixtures = {}; // id -> fixture doc data

    // helpers
    function safeToDate(v){
      if (!v) return null;
      if (typeof v.toDate === "function") return v.toDate();
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function isValidScore(v){
      if (v === null || v === undefined || v === "") return false;
      return !isNaN(Number(v));
    }

    // core: compute standings from fixtures
    function computeStandings(){
      const table = {}; // teamId -> stats

      // ensure every known team has an entry
      Object.keys(teams).forEach(id => {
        table[id] = {
          id,
          name: teams[id].name || id,
          logoUrl: teams[id].logoUrl || null,
          played: 0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0
        };
      });

      // also ensure teams that appear only in fixtures are present
      Object.values(fixtures).forEach(f => {
        if (!f.homeTeamId || !f.awayTeamId) return;
        if (!table[f.homeTeamId]) table[f.homeTeamId] = { id: f.homeTeamId, name: f.homeTeamId, logoUrl:null, played:0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0};
        if (!table[f.awayTeamId]) table[f.awayTeamId] = { id: f.awayTeamId, name: f.awayTeamId, logoUrl:null, played:0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0};
      });

      // process each fixture: count only if both scores valid
      Object.values(fixtures).forEach(f => {
        const home = f.homeTeamId; const away = f.awayTeamId;
        if (!home || !away) return;

        const hsRaw = f.homeScore; const asRaw = f.awayScore;
        if (!isValidScore(hsRaw) || !isValidScore(asRaw)) return; // skip unscored match

        const hs = Number(hsRaw);
        const as = Number(asRaw);

        // make sure records exist
        if (!table[home]) table[home] = { id: home, name: home, logoUrl:null, played:0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0};
        if (!table[away]) table[away] = { id: away, name: away, logoUrl:null, played:0, wins:0, draws:0, losses:0, gf:0, ga:0, gd:0, points:0};

        table[home].played += 1;
        table[away].played += 1;

        table[home].gf += hs;
        table[home].ga += as;
        table[away].gf += as;
        table[away].ga += hs;

        if (hs > as) {
          table[home].wins += 1; table[home].points += 3;
          table[away].losses += 1;
        } else if (hs < as) {
          table[away].wins += 1; table[away].points += 3;
          table[home].losses += 1;
        } else {
          table[home].draws += 1; table[away].draws += 1;
          table[home].points += 1; table[away].points += 1;
        }
      });

      // finalize GD
      Object.values(table).forEach(r => { r.gd = r.gf - r.ga; });

      // convert to array and sort by FIFA rules:
      // points desc, gd desc, gf desc, ga asc, name asc
      const arr = Object.values(table);
      arr.sort((a,b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.gd !== a.gd) return b.gd - a.gd;
        if (b.gf !== a.gf) return b.gf - a.gf;
        if (a.ga !== b.ga) return a.ga - b.ga; // lower GA better
        // final fallback alphabetical by name (case-insensitive)
        return (a.name || "").toString().localeCompare((b.name || "").toString(), undefined, {sensitivity:'base'});
      });

      return arr;
    }

    // render table
    function render(){
      const standings = computeStandings();
      tbody.innerHTML = "";

      if (standings.length === 0){
        tbody.innerHTML = `<tr><td colspan="10" class="small">No data yet (0 teams or no finished fixtures). Check Firestore collections 'teams' and 'fixtures'. Open console for counts.</td></tr>`;
        return;
      }

      standings.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td style="text-align:left">
            <div class="team-cell">
              <img src="${r.logoUrl || 'https://placehold.co/28'}" alt="" />
              <div style="margin-left:8px">${r.name}</div>
            </div>
          </td>
          <td>${r.played}</td>
          <td>${r.wins}</td>
          <td>${r.draws}</td>
          <td>${r.losses}</td>
          <td>${r.gf}</td>
          <td>${r.ga}</td>
          <td>${r.gd}</td>
          <td><strong>${r.points}</strong></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // listeners: teams and fixtures
    onSnapshot(teamsCol, snap => {
      teams = {};
      snap.forEach(d => {
        const data = d.data();
        teams[d.id] = {
          name: data.name || data.teamName || data.title || d.id,
          logoUrl: data.logoUrl || data.logo || null
        };
      });
      teamsCountEl.textContent = Object.keys(teams).length;
      console.log("[league] teams loaded:", Object.keys(teams).length);
      render();
    });

    onSnapshot(fixturesCol, snap => {
      fixtures = {};
      snap.forEach(d => {
        fixtures[d.id] = d.data();
      });
      fixturesCountEl.textContent = Object.keys(fixtures).length;
      console.log("[league] fixtures loaded:", Object.keys(fixtures).length);
      render();
    });

    // manual refresh (recompute)
    refreshBtn.addEventListener("click", () => {
      render();
      console.log("[league] manual refresh");
    });

    // initial small debug log
    console.log("[league] league-table loaded — listening to teams & fixtures collections.");
  </script>
</body>
</html>
